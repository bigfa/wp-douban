"use strict";function _toConsumableArray(a){return _arrayWithoutHoles(a)||_iterableToArray(a)||_unsupportedIterableToArray(a)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(a,b){if(a){if("string"==typeof a)return _arrayLikeToArray(a,b);var c=Object.prototype.toString.call(a).slice(8,-1);return"Object"===c&&a.constructor&&(c=a.constructor.name),"Map"===c||"Set"===c?Array.from(a):"Arguments"===c||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(c)?_arrayLikeToArray(a,b):void 0}}function _iterableToArray(a){return"undefined"!=typeof Symbol&&null!=a[Symbol.iterator]||null!=a["@@iterator"]?Array.from(a):void 0}function _arrayWithoutHoles(a){return Array.isArray(a)?_arrayLikeToArray(a):void 0}function _arrayLikeToArray(a,b){(null==b||b>a.length)&&(b=a.length);for(var c=0,d=new Array(b);b>c;c++)d[c]=a[c];return d}function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}function _defineProperties(a,b){var c,d;for(c=0;c<b.length;c++)d=b[c],d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}function _createClass(a,b,c){return b&&_defineProperties(a.prototype,b),c&&_defineProperties(a,c),Object.defineProperty(a,"prototype",{writable:!1}),a}var WP_DOUBAN=function(){function a(){_classCallCheck(this,a),this.ver="1.0.4",this.type="movie",this.finished=!1,this.paged=1,this.genre_list=[],this.genre=[],this.subjects=[],this._create()}return _createClass(a,[{key:"on",value:function(a,b,c){var d=document.querySelectorAll(b);d.forEach(function(b){b.addEventListener(a,c)})}},{key:"_addSearchParams",value:function(a){var c,b=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return a=new URL(a),c=new URL("".concat(a.origin).concat(a.pathname,"?").concat(new URLSearchParams([].concat(_toConsumableArray(Array.from(a.searchParams.entries())),_toConsumableArray(Object.entries(b)))))),c.href}},{key:"_fetchGenres",value:function(){var b,a=this;return document.querySelector(".db--genres").innerHTML="",b=wpd_base.token?"https://node.wpista.com/v1/outer/genres?token="+wpd_base.token:wpd_base.api+"v1/movie/genres",fetch(this._addSearchParams(b,{type:this.type})).then(function(a){return a.json()}).then(function(b){var c=wpd_base.token?b.data:b;c.length&&(a.genre_list=c,a._renderGenre())}),!0}},{key:"_handleGenreClick",value:function(){var a=this;this.on("click",".db--genreItem",function(b){var d,c=b.target;return c.classList.contains("is-active")?(d=a.genre.indexOf(c.innerText),c.classList.remove("is-active"),a.genre.splice(d,1),a.paged=1,a.finished=!1,a.subjects=[],a._fetchData(),void 0):(document.querySelector(".db--list").innerHTML="",document.querySelector(".lds-ripple").classList.remove("u-hide"),c.classList.add("is-active"),a.genre.push(c.innerText),a.paged=1,a.finished=!1,a.subjects=[],a._fetchData(),void 0)})}},{key:"_renderGenre",value:function(){var a=this;document.querySelector(".db--genres").innerHTML=this.genre_list.map(function(b){return'<span class="db--genreItem'.concat(a.genre_list.includes(b.name)?" is-active":"",'">').concat(b.name,"</span>")}).join(""),this._handleGenreClick()}},{key:"_fetchData",value:function(){var a=this,b=wpd_base.token?"https://node.wpista.com/v1/outer/faves":wpd_base.api+"v1/movies";fetch(this._addSearchParams(b,{token:wpd_base.token,type:this.type,paged:this.paged,genre:JSON.stringify(this.genre)})).then(function(a){return a.json()}).then(function(b){var c=wpd_base.token?b.data:b;c.length?(document.querySelector(".db--list").classList.contains("db--list__card")?(a.subjects=[].concat(_toConsumableArray(a.subjects),_toConsumableArray(c)),a._randerDateTemplate()):(a.subjects=[].concat(_toConsumableArray(a.subjects),_toConsumableArray(c)),a._randerListTemplate()),document.querySelector(".lds-ripple").classList.add("u-hide")):(a.finished=!0,document.querySelector(".lds-ripple").classList.add("u-hide"))})}},{key:"_randerDateTemplate",value:function(){var c,d,a=this.subjects.reduce(function(a,b){var c=new Date(b.create_time),d=c.getFullYear(),e=c.getMonth()+1,f="".concat(d,"-").concat(e.toString().padStart(2,"0"));return Object.prototype.hasOwnProperty.call(a,f)?a[f].push(b):a[f]=[b],a},{}),b="";for(c in a)d=c.split("-"),b+='<div class="db--listBydate"><div class="db--titleDate JiEun"><div class="db--titleDate__day">'.concat(d[1],'</div><div class="db--titleDate__month">').concat(d[0],'</div></div><div class="db--dateList__card">'),b+=a[c].map(function(a){return'<div class="db--item">'.concat(a.is_top250?'<span class="top250">Top 250</span>':"",'<img src="').concat(a.poster,'" referrerpolicy="no-referrer" class="db--image"><div class="db--score JiEun">').concat(a.douban_score>0?'<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor" ><path d="M12 20.1l5.82 3.682c1.066.675 2.37-.322 2.09-1.584l-1.543-6.926 5.146-4.667c.94-.85.435-2.465-.799-2.567l-6.773-.602L13.29.89a1.38 1.38 0 0 0-2.581 0l-2.65 6.53-6.774.602C.052 8.126-.453 9.74.486 10.59l5.147 4.666-1.542 6.926c-.28 1.262 1.023 2.26 2.09 1.585L12 20.099z"></path></svg>'+a.douban_score:"").concat(a.year>0?" · "+a.year:"",'</div><div class="db--title"><a href="').concat(a.link,'" target="_blank">').concat(a.name,"</a></div>\n    \n    </div>")}).join(""),b+="</div></div>";document.querySelector(".db--list").innerHTML=b}},{key:"_randerListTemplate",value:function(){document.querySelector(".db--list").innerHTML=this.subjects.map(function(a){return'<div class="db--item">'.concat(a.is_top250?'<span class="top250">Top 250</span>':"",'<img src="').concat(a.poster,'" referrerpolicy="no-referrer" class="db--image"><div class="ipc-signpost JiEun">').concat(a.create_time,'</div><div class="db--score JiEun">').concat(a.douban_score>0?'<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor" ><path d="M12 20.1l5.82 3.682c1.066.675 2.37-.322 2.09-1.584l-1.543-6.926 5.146-4.667c.94-.85.435-2.465-.799-2.567l-6.773-.602L13.29.89a1.38 1.38 0 0 0-2.581 0l-2.65 6.53-6.774.602C.052 8.126-.453 9.74.486 10.59l5.147 4.666-1.542 6.926c-.28 1.262 1.023 2.26 2.09 1.585L12 20.099z"></path></svg>'+a.douban_score:"").concat(a.year>0?" · "+a.year:"",'</div><div class="db--title"><a href="').concat(a.link,'" target="_blank">').concat(a.name,"</a></div>\n                </div>\n                </div>")}).join("")}},{key:"_handleScroll",value:function(){var a=this;window.addEventListener("scroll",function(){var b=window.scrollY||window.pageYOffset;document.querySelector(".block-more").offsetTop+-window.innerHeight<b&&document.querySelector(".lds-ripple").classList.contains("u-hide")&&!a.finished&&(document.querySelector(".lds-ripple").classList.remove("u-hide"),a.paged++,a._fetchData())})}},{key:"_handleNavClick",value:function(){var a=this;this.on("click",".db--navItem",function(b){if(!b.target.classList.contains("current")){a.genre=[],a.type=b.target.dataset.type,"book"!=a.type?(a._fetchGenres(),document.querySelector(".db--genres").classList.remove("u-hide")):document.querySelector(".db--genres").classList.add("u-hide"),document.querySelector(".db--list").innerHTML="",document.querySelector(".lds-ripple").classList.remove("u-hide"),document.querySelector(".db--navItem.current").classList.remove("current");var c=b.target;c.classList.add("current"),a.paged=1,a.finished=!1,a.subjects=[],a._fetchData()}})}},{key:"_create",value:function(){var a=this;document.querySelector(".db--container")&&(document.querySelector(".db--navItem.current")&&(this.type=document.querySelector(".db--navItem.current").dataset.type),document.querySelector(".db--list").dataset.type&&(this.type=document.querySelector(".db--list").dataset.type),"movie"==this.type&&document.querySelector(".db--genres").classList.remove("u-hide"),this._fetchGenres(),this._fetchData(),this._handleScroll(),this._handleNavClick()),document.querySelector(".db--collection")&&document.querySelectorAll(".db--collection").forEach(function(b){a._fetchCollection(b)})}},{key:"_fetchCollection",value:function(a){var b=a.dataset.style?a.dataset.style:"card",c=wpd_base.token?"https://node.wpista.com/v1/outer/faves?token="+wpd_base.token:wpd_base.api+"v1/movies";fetch(this._addSearchParams(c,{type:this.type,paged:1,start_time:a.dataset.start,end_time:a.dataset.end})).then(function(a){return a.json()}).then(function(c){var e,f,g,d=wpd_base.token?c.data:c;if(d.length)if("card"==b)a.innerHTML+=d.map(function(a){return'<div class="doulist-item">\n                            <div class="doulist-subject">\n                            <div class="db--viewTime JiEun">Marked '.concat(a.create_time,'</div>\n                            <div class="doulist-post"><img referrerpolicy="no-referrer" src="').concat(a.poster,'"></div><div class="doulist-content"><div class="doulist-title"><a href="').concat(a.link,'" class="cute" target="_blank" rel="external nofollow">').concat(a.name,'</a></div><div class="rating"><span class="allstardark"><span class="allstarlight" style="width:75%"></span></span><span class="rating_nums">').concat(a.douban_score,'</span></div><div class="abstract">').concat(a.remark||a.card_subtitle,"</div></div></div></div>")}).join("");else{e=d.reduce(function(a,b){return Object.prototype.hasOwnProperty.call(a,b.create_time)?a[b.create_time].push(b):a[b.create_time]=[b],a},{}),f="";for(g in e)f+='<div class="db--date">'.concat(g,'</div><div class="db--dateList">'),f+=e[g].map(function(a){return'<div class="db--card__list"">\n                                    <img referrerpolicy="no-referrer" src="'.concat(a.poster,'">\n                                    <div>\n                                    <div class="title"><a href="').concat(a.link,'" class="cute" target="_blank" rel="external nofollow">').concat(a.name,'</a></div>\n                                    <div class="rating"><span class="allstardark"><span class="allstarlight" style="width:75%"></span></span><span class="rating_nums">').concat(a.douban_score,"</span></div>\n                                    ").concat(a.remark||a.card_subtitle,"\n                                    </div>\n                                    </div>")}).join(""),f+="</div>";a.innerHTML=f}})}}]),a}();new WP_DOUBAN;
